{% extends "clinical_app/base.html" %}

{% block title %}{{ patient.full_name }} - Patient Details{% endblock %}

{% block content %}
<style>
    /* Global Styles for the Modern & Professional look */
    .card {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }
    .card-header {
        background-color: #f1f5f9;
        border-bottom: 2px solid; /* A accent color will be added by a specific class below */
        color: #1f2937;
        font-weight: 600;
    }
    .table-responsive .table thead th {
        background-color: #e2e8f0;
        color: #4b5563;
        font-weight: 600;
        border-bottom: 2px solid #cbd5e1;
    }

    /* Specific accent colors for each card type */
    .card-demographics .card-header { border-color: #3b82f6; } /* Blue */
    .card-vitals .card-header      { border-color: #3b82f6; } /* Blue */
    .card-diagnoses .card-header  { border-color: #10b981; } /* Green */
    .card-consent .card-header    { border-color: #64748b; } /* Gray */
    .card-encounters .card-header { border-color: #f59e0b; } /* Amber */

    /* Custom styles for list groups in the consent forms card */
    .list-group-item {
        border-color: #e2e8f0;
    }
</style>

<div class="container-fluid py-4">
    {# Page Header #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-primary mb-0">
            <i class="fas fa-user-injured me-3"></i>{{ patient.full_name }} ({{ patient.patient_id }})
        </h4>

        <div class="d-flex gap-2">
            <a href="{% url 'patient_list' %}" class="btn btn-outline-secondary btn-sm d-flex align-items-center">
                <i class="fas fa-arrow-left me-2"></i> Back to Patients
            </a>
            {% if user.is_authenticated and user.user_type == 'admin' %}
                <a href="{% url 'patient_update' patient.pk %}" class="btn btn-warning btn-sm d-flex align-items-center">
                    <i class="fas fa-edit me-2"></i> Edit Patient Info
                </a>
            {% endif %}
            {% if user.user_type == 'doctor' or user.user_type == 'nurse' %}
                <a href="{% url 'encounter_create' %}?patient={{ patient.pk }}" class="btn btn-success btn-sm d-flex align-items-center">
                    <i class="fas fa-stethoscope me-2"></i> Start New Encounter
                </a>
            {% endif %}
        </div>
    </div>

    {# Patient Demographics and Recent Vitals/Diagnoses Sections #}
    <div class="row">
        {# Patient Demographics Card (Updated) #}
<div class="col-lg-5 col-md-12 ">
    <div class="card shadow-sm  card-demographics">
        <div class="card-header d-flex align-items-center py-3">
            <i class="fas fa-id-card-alt fa-lg me-2 text-primary"></i>
            <h6 class="mb-0 fw-bold">Patient Demographics</h6>
            <span class="badge bg-primary text-white ms-auto">ID: {{ patient.patient_id }}</span>
        </div>
        <div class="card-body py-2">
            <div class="row g-1 small">
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-user-circle me-1 text-primary"></i>
                        <strong class="fw-bold">Name:</strong> {{ patient.full_name }}
                    </p>
                </div>
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-birthday-cake me-1 text-primary"></i>
                        <strong class="fw-bold">DOB:</strong> {{ patient.date_of_birth|date:"M d, Y"|default:"N/A" }}
                    </p>
                </div>
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-venus-mars me-1 text-primary"></i>
                        <strong class="fw-bold">Gender:</strong> {{ patient.get_gender_display|default:"N/A" }}
                    </p>
                </div>
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-phone-alt me-1 text-primary"></i>
                        <strong class="fw-bold">Phone:</strong> {{ patient.phone_number|default:"N/A" }}
                    </p>
                </div>
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-map-marker-alt me-1 text-primary"></i>
                        <strong class="fw-bold">Address:</strong> {{ patient.address|default:"N/A" }}
                    </p>
                </div>
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-tint me-1 text-danger"></i>
                        <strong class="fw-bold">Blood Group:</strong> {{ patient.blood_group|default:"N/A" }}
                    </p>
                </div>
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-calendar-alt me-1 text-primary"></i>
                        <strong class="fw-bold">Reg. Date:</strong> {{ patient.registration_date|date:"M d, Y" }}
                    </p>
                </div>
                <div class="col-sm-6">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-user-shield me-1 text-success"></i>
                        <strong class="fw-bold">Emergency Contact:</strong> {{ patient.emergency_contact_name }}
                    </p>
                </div>
                <div class="col-12">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-allergies me-1 text-warning"></i>
                        <strong class="fw-bold">Allergies:</strong> {{ patient.allergies|default:"None" }}
                    </p>
                </div>
                <div class="col-12">
                    <p class="mb-1 text-truncate">
                        <i class="fas fa-stethoscope me-1 text-secondary"></i>
                        <strong class="fw-bold">Pre-existing Conditions:</strong> {{ patient.pre_existing_conditions|default:"None" }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

        {# Recent Vitals and Diagnoses Column #}
        <div class="col-lg-7 col-md-12 mb-4">
            {# Recent Vital Signs Card #}
            <div class="card shadow-sm mb-4 card-vitals">
                <div class="card-header d-flex align-items-center py-3">
                    <i class="fas fa-heartbeat fa-lg me-2 text-primary"></i>
                    <h6 class="mb-0 fw-bold">Vital Signs</h6>
<a href="{% url 'vitals_create' patient.pk %}" class="btn btn-sm btn-outline-primary ms-auto d-flex align-items-center">
    <i class="fas fa-plus me-2"></i> Add Vitals
</a>
                </div>
                <div class="card-body">
                    {% if vitals %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Temp (Â°C)</th>
                                        <th>BP (mmHg)</th>
                                        <th>HR (bpm)</th>
                                        <th>RR (rpm)</th>
                                        <th>SpO2 (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vital in vitals %}
                                        <tr>
                                            <td>{{ vital.timestamp|date:"M d, Y P" }}</td>
                                            <td>{{ vital.temperature|default:"N/A" }}</td>
                                            <td>{{ vital.blood_pressure_systolic|default:"N/A" }}/{{ vital.blood_pressure_diastolic|default:"N/A" }}</td>
                                            <td>{{ vital.heart_rate|default:"N/A" }}</td>
                                            <td>{{ vital.respiratory_rate|default:"N/A" }}</td>
                                            <td>{{ vital.oxygen_saturation|default:"N/A" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No recent vital signs recorded for this patient.</p>
                    {% endif %}
                </div>
            </div>

            {# Recent Diagnoses Card #}
            <div class="card shadow-sm mb-4 card-diagnoses">
                <div class="card-header d-flex align-items-center py-3">
                    <i class="fas fa-diagnoses fa-lg me-2 text-success"></i>
                    <h6 class="mb-0 fw-bold">Diagnoses</h6>
                </div>
                <div class="card-body">
                    {% if diagnoses %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Diagnosis</th>
                                        <th>ICD-10 Code</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for diag in diagnoses %}
                                        <tr>
                                            <td>{{ diag.diagnosis_date|date:"M d, Y" }}</td>
                                            <td>{{ diag.diagnosis_text }}</td>
                                            <td>{{ diag.icd10_code|default:"N/A" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No recent diagnoses recorded for this patient.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Consent Forms and Patient Encounters Sections (Full Width) #}
    <div class="row">
        {# Consent Forms Card #}
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card shadow-sm h-100 card-consent">
                <div class="card-header d-flex align-items-center py-3">
                    <i class="fas fa-file-contract fa-lg me-2 text-secondary"></i>
                    <h6 class="mb-0 fw-bold">Consent Forms</h6>
                    <a href="{% url 'consent_create' patient.pk %}" class="btn btn-sm btn-outline-secondary ms-auto d-flex align-items-center">
                        <i class="fas fa-plus me-2"></i> Add New Consent
                    </a>
                </div>
                <div class="card-body">
                    {% if consent_forms %}
                        <ul class="list-group list-group-flush">
                            {% for consent in consent_forms %}
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 fw-bold">{{ consent.consent_type }}</h6>
                                        <p class="mb-1 mt-2 text-muted small">{{ consent.consent_text }}</p>
                                        <p class="mb-1 small">
                                            <strong>Signed:</strong>
                                            {% if consent.is_signed %}
                                                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary"><i class="fas fa-times-circle me-1"></i> No</span>
                                            {% endif %}
                                            {% if consent.signed_date %}, on {{ consent.signed_date|date:"M d, Y P" }}{% endif %}
                                            {% if consent.signed_by_staff %}, by {{ consent.signed_by_staff.get_full_name }}{% endif %}
                                        </p>
                                        {% if consent.signature_image %}
                                            <div class="mt-2">
                                                <p class="small fw-bold mb-1">Signature:</p>
                                                <img src="{{ consent.signature_image.url }}" alt="Digital Signature" class="img-fluid rounded" style="max-width: 200px; border: 1px solid #eee;" />
                                            </div>
                                        {% else %}
                                            <p class="small text-muted mb-0"><em>No signature image available.</em></p>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted text-center py-4">No consent forms recorded for this patient.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Patient Encounters Card #}
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card shadow-sm h-100 card-encounters">
                <div class="card-header d-flex align-items-center py-3">
                    <i class="fas fa-history fa-lg me-2 text-warning"></i>
                    <h6 class="mb-0 fw-bold">Patient Encounters</h6>
                </div>
                <div class="card-body">
                    {% if encounters %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Doctor</th>
                                        <th>Type</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for encounter in encounters %}
                                        <tr>
                                            <td>{{ encounter.encounter_date|date:"M d, Y P" }}</td>
                                            <td>{{ encounter.doctor.user.get_full_name|default:"N/A" }}</td>
                                            <td>{{ encounter.get_encounter_type_display }}</td>
                                            <td class="text-end">
                                                <a href="{% url 'encounter_detail' encounter.pk %}" class="btn btn-outline-info btn-sm">
                                                    <i class="fas fa-eye me-1"></i> View
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No encounters found for this patient.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
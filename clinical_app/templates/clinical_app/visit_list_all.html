{% extends 'clinical_app/base.html' %}
{% block content %}
<div class="container-fluid py-4">
                        {% if messages %}
                        <div class="messages mb-3">
                            {% for message in messages %}
                                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0 text-gradient text-primary">
                <i class="fas fa-notes-medical me-2"></i> Patient Visits
            </h2>
            <p class="text-sm text-muted mb-0">Manage all patient visit records</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back
            </a>
            <a href="{% url 'patient_list' %}" class="btn btn-sm btn-info">
                <i class="fas fa-user-injured me-1"></i> Patient List
            </a>
            <a href="{% url 'appointment_calendar' %}" class="btn btn-sm btn-warning">
                <i class="fas fa-calendar-check me-1"></i> Appointments
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-sm-6">
            <div class="card card-statistic bg-gradient-primary shadow-primary border-0">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="d-flex align-items-center">
                                <h3 class="mb-0 text-white">{{ total_visits }}</h3>
                            </div>
                            <p class="mb-0 text-sm text-white">Total Visits</p>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-notes-medical text-white text-lg opacity-10"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card card-statistic bg-gradient-info shadow-info border-0">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="d-flex align-items-center">
                                <h3 class="mb-0 text-white">{{ total_patients }}</h3>
                            </div>
                            <p class="mb-0 text-sm text-white">Total Patients</p>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-user-injured text-white text-lg opacity-10"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if visits %}
        <div class="card shadow-lg border-0 rounded-3">
<div class="card-header pb-0 bg-white">
    <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Recent Patient Visits</h6>
        <form method="GET" class="d-flex align-items-center">
            <div class="input-group input-group-outline w-75">
    <input type="text" class="form-control form-control-sm" placeholder="Search visits..." name="q" id="searchInput" value="{{ request.GET.q|default:'' }}">
</div>
            <button class="btn btn-primary btn-sm mb-0 ms-2" type="submit">
                <i class="fas fa-search"></i> Search
            </button>
        </form>
    </div>
</div>
            <div class="card-body px-0 pt-0 pb-2">
                <div class="table-responsive p-0">
                    <table class="table align-items-center mb-0" id="visitsTable">
                        <thead>
                            <tr>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-4">Patient</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Visit Date</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Gender</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Reason</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visit in page_obj %}
                                <tr class="border-bottom">
                                    <td>
                                        <div class="d-flex px-2 py-1">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ visit.patient.full_name }}</h6>
                                                <p class="text-xs text-secondary mb-0">ID: {{ visit.patient.patient_id }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-secondary text-xs font-weight-bold">{{ visit.visit_date|date:"M d, Y" }}</span>
                                        <p class="text-xs text-muted mb-0">{{ visit.visit_date|date:"h:i A" }}</p>
                                    </td>
                                    <td>
                                        <p class="text-sm font-weight-bold mb-0 text-capitalize">{{ visit.patient.gender|default:"N/A" }}</p>
                                    </td>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0 text-truncate" style="max-width: 150px;">{{ visit.reason|default:"N/A" }}</p>
                                    </td>
<td>
    {% if visit.status == "waiting_triage" %}
        <span class="badge-gradient bg-gradient-waiting_triage">Waiting for Triage</span>
    {% elif visit.status == "triage" %}
        <span class="badge-gradient bg-gradient-triage">In Triage</span>
    {% elif visit.status == "waiting_consultation" %}
        <span class="badge-gradient bg-gradient-waiting_consultation">Waiting for Consultation</span>
    {% elif visit.status == "consultation" %}
        <span class="badge-gradient bg-gradient-consultation">In Consultation</span>
    {% elif visit.status == "waiting_lab" %}
        <span class="badge-gradient bg-gradient-warning">Waiting for Lab</span>
    {% elif visit.status == "lab" %}
        <span class="badge-gradient bg-gradient-info">In Lab</span>
    {% elif visit.status == "waiting_pharmacy" %}
        <span class="badge-gradient bg-gradient-warning">Waiting for Pharmacy</span>
    {% elif visit.status == "pharmacy" %}
        <span class="badge-gradient bg-gradient-pharmacy">In Pharmacy</span>
    {% elif visit.status == "completed" %}
        <span class="badge-gradient bg-gradient-completed">Completed</span>
    {% endif %}
</td>

                                    <td class="align-middle text-center">
                                        <a href="{% url 'visit_detail' visit.pk %}" class="btn btn-sm bg-gradient-info text-white me-1" title="View" data-bs-toggle="tooltip">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'visit_edit' visit.pk %}" class="btn btn-sm bg-gradient-warning text-dark me-1" title="Edit" data-bs-toggle="tooltip">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'patient_detail' visit.patient.id %}" class="btn btn-sm bg-gradient-success text-white" title="Patient Profile" data-bs-toggle="tooltip">
                                            <i class="fas fa-user"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer pt-0 bg-white">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-end mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="First Page">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}

                        {% for i in paginator.page_range %}
                            {% if page_obj.number == i %}
                                <li class="page-item active" aria-current="page"><a class="page-link" href="#">{{ i }}</a></li>
                            {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                                <li class="page-item"><a class="page-link" href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ i }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Last Page">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    {% else %}
        <div class="card shadow-lg border-0 rounded-3">
            <div class="card-body p-5 text-center">
                <div class="icon icon-shape bg-gradient-info text-white text-lg rounded-circle mb-4">
                    <i class="fas fa-notes-medical opacity-10"></i>
                </div>
                <h5 class="mb-3">No visits recorded yet</h5>
                <p class="text-muted mb-4">When you start adding patient visits, they will appear here.</p>
            </div>
        </div>
    {% endif %}
</div>

<style>
.badge-gradient {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 0.8rem;
    font-weight: 600;
    color: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    white-space: nowrap;
}
   .bg-gradient-primary {
        background: linear-gradient(87.4deg, #4e73df 0%, #224abe 100%);
    }
    .bg-gradient-info {
        background: linear-gradient(87.4deg, #36b9cc 0%, #258391 100%);
    }
    .bg-gradient-success {
        background: linear-gradient(87.4deg, #1cc88a 0%, #13855c 100%);
    }
    .bg-gradient-warning {
        background: linear-gradient(87.4deg, #f6c23e 0%, #dda20a 100%);
    }
    .bg-gradient-danger {
        background: linear-gradient(87.4deg, #e74a3b 0%, #be2617 100%);
    }

    .bg-gradient-waiting_triage {
    background: linear-gradient(87deg, #f6d365, #fda085); /* orange-ish */
}
.bg-gradient-triage {
    background: linear-gradient(87deg, #36d1dc, #5b86e5); /* blue */
}
.bg-gradient-waiting_consultation {
    background: linear-gradient(87deg, #ff9a9e, #fad0c4); /* pink */
}
.bg-gradient-consultation {
    background: linear-gradient(87deg, #11998e, #38ef7d); /* green */
}
.bg-gradient-pharmacy {
    background: linear-gradient(87deg, #c33764, #1d2671); /* purple */
}
.bg-gradient-completed {
    background: linear-gradient(87deg, #56ab2f, #a8e063); /* light green */
}




    /* New CSS for Status Badges */
    .bg-gradient-pending {
        background: linear-gradient(87.4deg, #ffc107 0%, #d39e00 100%); /* Yellowish-Orange */
    }
    .bg-gradient-ongoing {
        background: linear-gradient(87.4deg, #007bff 0%, #0056b3 100%); /* Blue */
    }
    .bg-gradient-completed {
        background: linear-gradient(87.4deg, #28a745 0%, #1a6b2a 100%); /* Green */
    }

    /* General text and card styles */
    .text-gradient {
        background: linear-gradient(87.4deg, #4e73df 0%, #224abe 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .card-statistic {
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    .card-statistic:hover {
        transform: translateY(-5px);
    }
    .btn {
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    .btn:hover {
        transform: translateY(-2px);
    }
    .table tr {
        transition: all 0.2s ease;
    }
    .table tr:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }
    .icon-shape {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
    }
    .table-compact td,
    .table-compact th {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }
</style>

<script>
    function performSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchText = searchInput.value;
        if (searchText) {
            window.location.href = `?q=${encodeURIComponent(searchText)}`;
        } else {
            window.location.href = window.location.pathname;
        }
    }

    document.getElementById('searchInput').addEventListener('keyup', function(event) {
        if (event.key === "Enter") {
            performSearch();
        }
    });

    document.getElementById('searchButton').addEventListener('click', performSearch);

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>
{% endblock %}